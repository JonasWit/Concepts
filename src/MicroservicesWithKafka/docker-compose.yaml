version: "3.8"

services:
  post-cmd-api:
    build:
      context: .
      dockerfile: SM-Post/Post.Cmd/Post.Cmd.Api/Dockerfile
    container_name: post-cmd-api
    ports:
      - "5010:80"
    networks:
      - mydockernetwork
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      # Replace these host env vars with your secret values (or use prod.env)
      - MongoDbConfig__ConnectionString=${MONGODB_CONNECTION}
      - MongoDbConfig__Database=${MONGODB_DATABASE}
      - MongoDbConfig__Collection=${MONGODB_COLLECTION}
      - ProducerConfig__BootstrapServers=${KAFKA_BOOTSTRAP_SERVERS}
    depends_on:
      - kafka
      - mongo-container
    restart: unless-stopped

  post-query-api:
    build:
      context: .
      dockerfile: SM-Post/Post.Query/Post.Query.Api/Dockerfile
    container_name: post-query-api
    ports:
      - "5011:80"
    networks:
      - mydockernetwork
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      # Replace these host env vars with your secret values (or use prod.env)
      - ConnectionStrings__SqlServer=${SQLSERVER_CONNECTION}
      - ConsumerConfig__GroupId=${CONSUMER_GROUP_ID}
      - ConsumerConfig__BootstrapServers=${KAFKA_BOOTSTRAP_SERVERS}
      - ConsumerConfig__EnableAutoCommit=${CONSUMER_ENABLE_AUTO_COMMIT}
      - ConsumerConfig__AutoOffsetReset=${CONSUMER_AUTO_OFFSET_RESET}
      - ConsumerConfig__AllowAutoCreateTopics=${CONSUMER_ALLOW_AUTO_CREATE_TOPICS}
    depends_on:
      - kafka
      - sql-container
    restart: unless-stopped

networks:
  mydockernetwork:
    external: true